local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local SoundService = game:GetService("SoundService")

-- Wait for GlobalState module
local GlobalState = require(ReplicatedStorage:WaitForChild("GlobalState"))
GlobalState:InitializeRemotes()

-- Get remote events
local remotes = ReplicatedStorage:WaitForChild("GameRemotes")
local timeUpdateRemote = remotes:WaitForChild("TimeUpdate")
local dayNightChangeRemote = remotes:WaitForChild("DayNightChange")
local gameStateRequestRemote = remotes:WaitForChild("GameStateRequest")

local TimeManager = {
	lastNightState = false,
	updateInterval = 0,

	-- POST-APOCALYPTIC DAY LIGHTING (Harsh, desolate, washed out)
	dayLighting = {
		Brightness = 0.8,
		ColorShift_Top = Color3.fromRGB(255, 220, 180), -- Dusty orange sky
		ColorShift_Bottom = Color3.fromRGB(180, 140, 100), -- Brown/tan horizon
		Ambient = Color3.fromRGB(90, 85, 75), -- Muted browns
		OutdoorAmbient = Color3.fromRGB(110, 95, 80), -- Dusty ambient
		ShadowSoftness = 0.5,
		ExposureCompensation = -0.3,
		ClockTime = 14.5
	},

	-- HORROR NIGHT LIGHTING (Dark, ominous, barely visible)
	nightLighting = {
		Brightness = 0.02, -- VERY dark
		ColorShift_Top = Color3.fromRGB(10, 12, 20), -- Almost black with blue tint
		ColorShift_Bottom = Color3.fromRGB(5, 5, 8), -- Near black
		Ambient = Color3.fromRGB(8, 8, 12), -- Minimal ambient
		OutdoorAmbient = Color3.fromRGB(12, 14, 20), -- Slight blue moonlight
		ShadowSoftness = 1,
		ExposureCompensation = -3.5,
		ClockTime = 3
	},

	-- DAWN LIGHTING (Eerie transition, red sky warning)
	dawnLighting = {
		Brightness = 0.3,
		ColorShift_Top = Color3.fromRGB(180, 90, 60), -- Blood red dawn
		ColorShift_Bottom = Color3.fromRGB(120, 60, 40), -- Dark orange
		Ambient = Color3.fromRGB(50, 40, 35),
		OutdoorAmbient = Color3.fromRGB(70, 50, 40),
		ShadowSoftness = 0.8,
		ExposureCompensation = -1,
		ClockTime = 6.5
	},

	-- DUSK LIGHTING (Final moments before darkness)
	duskLighting = {
		Brightness = 0.25,
		ColorShift_Top = Color3.fromRGB(140, 80, 100), -- Purple/red sunset
		ColorShift_Bottom = Color3.fromRGB(80, 40, 50), -- Dark crimson
		Ambient = Color3.fromRGB(40, 35, 45),
		OutdoorAmbient = Color3.fromRGB(55, 45, 55),
		ShadowSoftness = 0.9,
		ExposureCompensation = -1.5,
		ClockTime = 18.5
	},

	-- ATMOSPHERE SETTINGS
	dayAtmosphere = {
		Color = Color3.fromRGB(180, 160, 120), -- Dusty yellow
		Decay = Color3.fromRGB(150, 110, 70), -- Orange decay
		Glare = 0.8,
		Haze = 4, -- Heavy dust in air
		Density = 0.45 -- Thick atmosphere
	},

	nightAtmosphere = {
		Color = Color3.fromRGB(40, 45, 60), -- Dark blue
		Decay = Color3.fromRGB(10, 10, 10), -- Almost no decay
		Glare = 0,
		Haze = 10, -- Very limited visibility
		Density = 0.6 -- Thick, oppressive
	},

	-- POST-PROCESSING EFFECTS
	dayEffects = {
		bloomIntensity = 0.3,
		bloomSize = 24,
		bloomThreshold = 0.95,
		sunRaysIntensity = 0.15,
		sunRaysSpread = 0.8
	},

	nightEffects = {
		bloomIntensity = 0.8, -- Glowing eyes, lights pop
		bloomSize = 48,
		bloomThreshold = 0.8,
		sunRaysIntensity = 0,
		sunRaysSpread = 0
	}
}

-- Initialize professional lighting setup
function TimeManager:InitializeLighting()
	-- Apply day lighting first
	for property, value in pairs(self.dayLighting) do
		pcall(function()
			Lighting[property] = value
		end)
	end

	-- Create/setup atmosphere
	local atmosphere = Lighting:FindFirstChild("Atmosphere") or Instance.new("Atmosphere")
	atmosphere.Parent = Lighting
	for property, value in pairs(self.dayAtmosphere) do
		atmosphere[property] = value
	end

	-- FOG SETTINGS (Critical for atmosphere)
	Lighting.FogColor = Color3.fromRGB(150, 130, 100) -- Dusty fog
	Lighting.FogStart = 50
	Lighting.FogEnd = 350

	-- POST-PROCESSING: Bloom effect
	local bloom = Lighting:FindFirstChild("Bloom") or Instance.new("BloomEffect")
	bloom.Intensity = self.dayEffects.bloomIntensity
	bloom.Size = self.dayEffects.bloomSize
	bloom.Threshold = self.dayEffects.bloomThreshold
	bloom.Parent = Lighting

	-- POST-PROCESSING: Sun rays (day only)
	local sunRays = Lighting:FindFirstChild("SunRays") or Instance.new("SunRaysEffect")
	sunRays.Intensity = self.dayEffects.sunRaysIntensity
	sunRays.Spread = self.dayEffects.sunRaysSpread
	sunRays.Parent = Lighting

	-- POST-PROCESSING: Color correction for post-apocalyptic feel
	local colorCorrection = Lighting:FindFirstChild("ColorCorrection") or Instance.new("ColorCorrectionEffect")
	colorCorrection.Brightness = -0.05
	colorCorrection.Contrast = 0.2
	colorCorrection.Saturation = -0.3 -- Desaturated, dead world
	colorCorrection.TintColor = Color3.fromRGB(255, 245, 230) -- Slight sepia
	colorCorrection.Parent = Lighting

	-- POST-PROCESSING: Depth of field for cinematic feel
	local depthOfField = Lighting:FindFirstChild("DepthOfField") or Instance.new("DepthOfFieldEffect")
	depthOfField.FarIntensity = 0.3
	depthOfField.FocusDistance = 50
	depthOfField.InFocusRadius = 100
	depthOfField.NearIntensity = 0.75
	depthOfField.Parent = Lighting

	print("[TimeManager] Professional lighting system initialized")
end

-- Check if weather system is active (don't override weather effects)
function TimeManager:IsWeatherActive()
	local currentWeather = GlobalState.currentWeather
	return currentWeather ~= "Clear"
end

-- Enhanced transition with multiple phases
function TimeManager:TransitionLighting(isNight)
	-- DON'T override lighting if weather is active
	if self:IsWeatherActive() then
		print("[TimeManager] Weather active - skipping lighting override")
		-- Still update zombie spawn
		game.ReplicatedStorage:SetAttribute("IsNight", isNight)
		return
	end

	local targetLighting, targetAtmosphere, targetEffects

	if isNight then
		-- Transitioning TO night - use dusk first
		targetLighting = self.duskLighting
		targetAtmosphere = self.dayAtmosphere
		targetEffects = self.dayEffects

		-- Apply dusk
		self:ApplyLightingTransition(targetLighting, targetAtmosphere, targetEffects, false, 20)

		-- Then transition to full night
		task.wait(15)
		targetLighting = self.nightLighting
		targetAtmosphere = self.nightAtmosphere
		targetEffects = self.nightEffects
	else
		-- Transitioning TO day - use dawn first
		targetLighting = self.dawnLighting
		targetAtmosphere = self.dayAtmosphere
		targetEffects = self.dayEffects

		-- Apply dawn
		self:ApplyLightingTransition(targetLighting, targetAtmosphere, targetEffects, false, 20)

		-- Then transition to full day
		task.wait(15)
		targetLighting = self.dayLighting
		targetAtmosphere = self.dayAtmosphere
		targetEffects = self.dayEffects
	end

	self:ApplyLightingTransition(targetLighting, targetAtmosphere, targetEffects, isNight, 20)

	-- Zombie spawn toggle
	game.ReplicatedStorage:SetAttribute("IsNight", isNight)

	-- Atmospheric messages
	if isNight then
		print("[TimeManager] üåô NIGHT FALLS - Visibility severely reduced")
		print("‚ö†Ô∏è ZOMBIES: Maximum spawn rate activated!")
	else
		print("[TimeManager] ‚òÄÔ∏è DAWN BREAKS - The dead burn in daylight")
		print("üî• ZOMBIES: UV damage active - seek shade!")
	end
end

-- Apply lighting transition
function TimeManager:ApplyLightingTransition(targetLighting, targetAtmosphere, targetEffects, isNight, duration)
	local tweenInfo = TweenInfo.new(
		duration,
		Enum.EasingStyle.Quad,
		Enum.EasingDirection.InOut
	)

	-- Tween main lighting
	local lightingTween = TweenService:Create(Lighting, tweenInfo, targetLighting)
	lightingTween:Play()

	-- Tween atmosphere
	if Lighting:FindFirstChild("Atmosphere") then
		local atmosphereTween = TweenService:Create(Lighting.Atmosphere, tweenInfo, targetAtmosphere)
		atmosphereTween:Play()
	end

	-- Tween fog for visibility changes
	local fogTween = TweenService:Create(Lighting, tweenInfo, {
		FogColor = isNight and Color3.fromRGB(20, 20, 30) or Color3.fromRGB(150, 130, 100),
		FogStart = isNight and 10 or 50, -- VERY close fog at night
		FogEnd = isNight and 150 or 350 -- Limited visibility for horror
	})
	fogTween:Play()

	-- Tween post-processing effects
	if Lighting:FindFirstChild("Bloom") then
		local bloomTween = TweenService:Create(Lighting.Bloom, tweenInfo, {
			Intensity = targetEffects.bloomIntensity,
			Size = targetEffects.bloomSize,
			Threshold = targetEffects.bloomThreshold
		})
		bloomTween:Play()
	end

	if Lighting:FindFirstChild("SunRays") then
		local sunRaysTween = TweenService:Create(Lighting.SunRays, tweenInfo, {
			Intensity = targetEffects.sunRaysIntensity,
			Spread = targetEffects.sunRaysSpread
		})
		sunRaysTween:Play()
	end

	-- Color correction for night vision feel
	if Lighting:FindFirstChild("ColorCorrection") then
		local ccTween = TweenService:Create(Lighting.ColorCorrection, tweenInfo, {
			Brightness = isNight and -0.2 or -0.05,
			Contrast = isNight and 0.4 or 0.2,
			Saturation = isNight and -0.5 or -0.3,
			TintColor = isNight and Color3.fromRGB(200, 210, 255) or Color3.fromRGB(255, 245, 230)
		})
		ccTween:Play()
	end
end

-- Update game state and send to clients
function TimeManager:Update()
	local isNight = GlobalState:IsNight()

	-- Check for day/night change
	if isNight ~= self.lastNightState then
		self.lastNightState = isNight
		GlobalState.isNight = isNight
		GlobalState.timeOfDay = GlobalState:GetTimeOfDay()

		-- Transition lighting
		self:TransitionLighting(isNight)

		-- Notify all clients
		dayNightChangeRemote:FireAllClients({
			isNight = isNight,
			day = GlobalState.currentDay,
			timeOfDay = GlobalState.timeOfDay
		})

		if not isNight then
			-- Day survived notification
			task.spawn(function()
				_G.SendNotificationToAll("DaySurvived", GlobalState.currentDay)
			end)

			-- Increment day
			GlobalState.currentDay = GlobalState.currentDay + 1
			print("[TimeManager] Day " .. GlobalState.currentDay .. " survived!")

			-- New day notification (wait 3 seconds)
			task.wait(3)

			task.spawn(function()
				-- Get max zombies for new day
				local ZombieConfig = require(ReplicatedStorage:WaitForChild("ZombieConfig"))
				local maxZombies = ZombieConfig:GetMaxZombiesForDay(GlobalState.currentDay)
				_G.SendNotificationToAll("DayStart", GlobalState.currentDay, maxZombies)
			end)
		else
			-- Night falls notification
			task.spawn(function()
				_G.SendNotificationToAll("NightFalls")
			end)
		end
	end

	-- Send periodic updates to clients (every 10 seconds)
	self.updateInterval = self.updateInterval + 1
	if self.updateInterval >= 10 then
		self.updateInterval = 0

		local gameState = {
			isNight = GlobalState.isNight,
			timeOfDay = GlobalState:GetTimeOfDay(),
			timeRemaining = math.floor(GlobalState:GetTimeRemaining()),
			currentDay = GlobalState.currentDay,
			cycleProgress = GlobalState:GetVisualProgress()  -- Use visual progress for the bar
		}

		timeUpdateRemote:FireAllClients(gameState)
	end
end

-- Handle client requests for game state
gameStateRequestRemote.OnServerEvent:Connect(function(player)
	local gameState = {
		isNight = GlobalState.isNight,
		timeOfDay = GlobalState:GetTimeOfDay(),
		timeRemaining = math.floor(GlobalState:GetTimeRemaining()),
		currentDay = GlobalState.currentDay,
		cycleProgress = GlobalState:GetCycleProgress()
	}

	timeUpdateRemote:FireClient(player, gameState)
end)

-- Initialize and start the system
TimeManager:InitializeLighting()

-- Main update loop (runs every second)
RunService.Heartbeat:Connect(function()
	TimeManager:Update()
end)

print("[TimeManager] Post-apocalyptic lighting system online - Day " .. GlobalState.currentDay)
print("‚ö†Ô∏è Warning: Limited visibility at night. Stay in the light.")
